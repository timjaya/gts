---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# gts v`r as.character(packageVersion("gts"))`

<!-- badges: start -->
[![Lifecycle: experimental](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
<!-- badges: end -->

The goal of gts is to provide a `fable`-like interface to the `forecast` package.

## Installation

You can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("markfairbanks/gts")
```
## Functions

`gts` has 4 core functions:

* `ts_prep()`: Convert a data frame to a `gts` ready dataset
* `ts_model()`: Apply a `forecast` function
* `ts_forecast()`: Create forecasts for all trained models
* `ts_accuracy()`: Extract in-sample accuracy for all trained models

## Examples

Starting with some example data:

```{r message=FALSE}
library(gts)
library(janitor)
library(tsibbledata)

aus_df <- tsibbledata::aus_livestock %>%
  janitor::clean_names() %>%
  dt_arrange(animal, state) %>%
  dt_mutate(group_id = .GRP, by = list(animal, state)) %>%
  dt_filter(group_id <= 5) %>%
  dt_mutate(month = as_date(month))

head(aus_df)
```

We can now make a mable-like data.table. Note that you must use `.ts` when calling `ts_model()`.

```{r}
aus_mbl <- aus_df %>%
  ts_prep(key = c(animal, state), index = month, target = count) %>%
  ts_model(ets(.ts),
           ets(log(.ts + 1)),
           auto.arima(.ts))

aus_mbl
```

From the mable we can create a fable-like data.table

```{r warning=FALSE}
aus_fbl <- aus_mbl %>%
  ts_forecast(h = 12)

aus_fbl
```

You can also get in-sample accuracy from the mable:

```{r}
aus_mbl %>%
  ts_accuracy()
```


## Running in parallel

```{r warning=FALSE}
pacman::p_load(furrr)

model_fn <- function(.data) {
  .data %>%
    ts_model(ets(.ts),
             ets(log(.ts + 1)))
}

plan(multiprocess)

parallel_mbl <- aus_df %>%
  ts_prep(key = c(animal, state), index = month, target = count) %>%
  split(1:nrow(.) %% 6) %>%
  future_map_dfr(model_fn)

parallel_fbl <- parallel_mbl %>%
  split(1:nrow(.) %% 6) %>%
  future_map_dfr(ts_forecast)

future:::ClusterRegistry("stop")
```

